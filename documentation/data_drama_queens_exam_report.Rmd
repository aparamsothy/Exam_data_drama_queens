---
title: "RMED901A Exam Report"
author: "Data Drama Queens"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Read and Tidy


## Tidy, Adjust and Explore

Following are the codes from the script "20250908-tidy-adjust-explore.data.R". In this script we have futher tidied the data by removing unnecessary columns, joined with additional dataset, created new set of variables and ordered/arranged the variables. 

In this session we have also explored the dataset by stratifying for variables and reporting statistical characteristics of these variables.


### Load the necessary libraries
```{r libraries, warning=FALSE, message=FALSE}
library(tidyverse)
library(here)
```


### Read the datasets

We are reading in two dataset (main dataset: `patient_data`, joining dataset: `patient_data_join`) that we will merge at a later point in the script.

```{r read_data, warning=FALSE, message=FALSE}
patient_data <- read_delim(
  here("data", "data_for_analysis", "20250905-tidy-exam-data.txt"),
  delim = "\t"
)

patient_data_join <- read_delim(
  here("data", "original_data", "exam_data_join.txt"),
  delim = "\t"
)
```


### Explore the joining dataset

The joining data appears to have been read in correctly. We see that all the columns/variables in the joining dataset are numeric. 

There are a total of 5167 rows/observations and 10 columns. There are two variables (cal, alt) with missing values. 

There is the same numbers of rows as unique patient IDs which confirms that there are no duplicate IDs.

The joining dataset which will be joined to our main dataset looks ok.

```{r}
glimpse(patient_data_join)
head(patient_data_join)
skimr::skim(patient_data_join)
naniar::gg_miss_var(patient_data_join)

patient_data_join %>%
  count() # Number of rows

patient_data_join %>%
  distinct(patient_id) %>%
  count() # Number of unique patient IDs
```



### Remove unnessary variables abd join the datasets

We remove unnessary columns `hct`and `rdw` and join the two datasets together. 

By looking at the new combined dataset we see that all the variables are still numeric.

We have changed numerical to factor variables as specified in the codebook. 

After looking at the overview of the dataset again, we see that the variables `active` and `remission` are now factors.

```{r}
patient_data <- patient_data %>%
 select(-hct, -rdw) %>% 
 left_join(patient_data_join, join_by("patient_id"))

glimpse(patient_data)

patient_data <- patient_data %>%
  mutate(active = if_else(active == 0, factor("No"), factor("Yes"))) %>%
  mutate(remission = if_else(remission == 0, factor("No"), factor("Yes")))

glimpse(patient_data)
```


### Create new columns

We have created five new columns for later use: `hgb_quartiles`, `blood_ure_nitrogen_over_30`, `lymph_count`, `sodium_fraction` and `age_years`. The dataset have been arranged so that `age_days` and `blood_urea_nitrogen` comes after `patient_id`.

```{r}
patient_data <- patient_data %>% 
  mutate(hgb_quartiles = cut(hgb, breaks=4, labels = c("Q1", "Q2", "Q3", "Q4"))) %>% #Cut the hemoglobin level into quartiles 
  mutate(blood_urea_nitrogen_over_30 = if_else(blood_urea_nitrogen > 30, factor("Yes"), factor("No"))) %>% #create a column indicating if the blood urea nitrogen is above 30
  mutate(lymph_count = wbc * (lymph_percent/100)) %>% #add a column for Lymphocytes cell count
  mutate(sodium_fraction = (sodium / (sodium + potassium + chloride))) %>% #sodium as a fraction of summed sodium, potassium, and chloride
  select(patient_id, age_days, blood_urea_nitrogen, everything()) %>% # Set the order of columns
  arrange(patient_id) # arrange by patient ID

patient_data <- patient_data %>%
  mutate(age_years = round(age_days / 365.25)) # New variable for age in years
```


### Explore the new dataset after joining with new columns

We have counted the categorical variables to confirm that they were created correctly. 

We see from glimpsing the dataset that the new numerical variables seem to be created correctly. 

There are now 4 factor and 32 numerical variables.

There is most missing data for blood_urea_nitrogen and the column based on this (blood_urea_nitrogen_over_30). There is also missing values for 15 other columns.

```{r}
patient_data %>%
  count(hgb_quartiles) # Verify that the new column for hemoglobin quartiles makes sense

patient_data %>%
  count(blood_urea_nitrogen_over_30) # Verify that the categorical column for blood urea nitrogen makes sense


glimpse(patient_data)
skimr::skim(patient_data)
naniar::gg_miss_var(patient_data)
```


### Stratification and report min, max, mean and sd of variables

Here we answer the following:
1.Stratify the data by `hgb_quartiles` and report min, max, mean and sd of a `rbc`.
2.Stratify the by a `hgb_quatiles` and report min, max, mean and sd of a numeric column for a defined set of observations:
+Only for persons with hgb <= 10
+Only for persons with remission of inflamation
+Only for persons older than around 40 years of age
+Only for persons with more than 10% of monocytes in WBC
3.Use two categorical columns `active` and `remission` in the dataset to create a table

```{r}
# Stratification by hgb_quartiles and report min, max, mean and sd of rbc (red blood cell counts)
patient_data %>% 
  group_by(hgb_quartiles) %>%
  summarise(
    min_rbc = min(rbc, na.rm = TRUE),
    max_rbc = max(rbc, na.rm = TRUE),
    mean_rbc = mean(rbc, na.rm = TRUE),
    sd_rbc = sd(rbc, na.rm = TRUE)
  )

# among patients with hgb less than 10
patient_data %>%
  filter(hgb <= 10) %>%  
  group_by(hgb_quartiles) %>%          
  summarise(
    min_rbc_hgb10 = min(rbc, na.rm = TRUE),
    max_rbc_hgb10 = max(rbc, na.rm = TRUE),
    mean_rbc_hgb10 = mean(rbc, na.rm = TRUE),
    sd_rbc_hgb10 = sd(rbc, na.rm = TRUE)
  )

# among patients with remission of inflammation
patient_data %>% 
  filter(remission == "Yes") %>%
  group_by(hgb_quartiles) %>%
  summarise(
    min_rbc_remission = min(rbc, na.rm = TRUE),
    max_rbc_remission = max(rbc, na.rm = TRUE),
    mean_rbc_remission = mean(rbc, na.rm = TRUE),
    sd_rbc_remission = sd(rbc, na.rm = TRUE)
  )

# among patients older than around 40 years of age
patient_data %>%
  group_by(hgb_quartiles) %>%
  filter(age_years > 40) %>% # Already created a variable for age in years earlier
  summarize(mean_rbc_age = mean(rbc, na.rm = TRUE),
            min_rbc_age = min(rbc, na.rm = TRUE),
            max_rbc_age = max(rbc, na.rm = TRUE),
            sd_rbc_age = sd(rbc, na.rm = TRUE))

# among patients with more than 10% of monocytes in WBC
patient_data %>%
  group_by(hgb_quartiles) %>%
  filter(mono_percent > 10) %>%
  summarize(mean_rbc_mono = mean(rbc, na.rm = TRUE),
            min_rbc_mono = min(rbc, na.rm = TRUE),
            max_rbc_mono = max(rbc, na.rm = TRUE),
            sd_rbc_mono = sd(rbc, na.rm = TRUE))

# Create a table of remission vs active inflammation
table(patient_data$remission, patient_data$active)
```



```{r, include=FALSE}
# Save the joined data ----
filename <- paste0(here("data", "data_for_analysis", "20250908-tidy-joined-exam-data.txt"))
write_delim(
  patient_data, 
  file = filename,
  delim = "\t"
)
```


## Plot Creation

## Statistical Tests
